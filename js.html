<script>
// í˜„ì¬ ë‹¨ê³„ ì¶”ì 
let currentStep = 1;
const totalSteps = 5;

// ë‹¨ê³„ ë³€ê²½ í•¨ìˆ˜
function changeStep(step) {
    // í˜„ì¬ ë‹¨ê³„ ìˆ¨ê¸°ê¸°
    document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('active');
    document.querySelectorAll(`.progress-step[data-step="${currentStep}"]`).forEach(el => {
        el.classList.remove('active');
    });
    
    // ìƒˆ ë‹¨ê³„ í‘œì‹œ
    document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
    document.querySelectorAll(`.progress-step[data-step="${step}"]`).forEach(el => {
        el.classList.add('active');
    });
    
    currentStep = step;
    
    // ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œëŠ” ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
    if (step === totalSteps) {
        updateSummary();
    }
}

// ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
function nextStep() {
    // í˜„ì¬ ë‹¨ê³„ ìœ íš¨ì„± ê²€ì‚¬
    if (!validateCurrentStep()) {
        return;
    }
    
    if (currentStep < totalSteps) {
        changeStep(currentStep + 1);
    }
}

// ì´ì „ ë‹¨ê³„ë¡œ ì´ë™
function prevStep() {
    if (currentStep > 1) {
        changeStep(currentStep - 1);
    }
}

// í˜„ì¬ ë‹¨ê³„ ìœ íš¨ì„± ê²€ì‚¬
function validateCurrentStep() {
    const currentForm = document.querySelector(`.form-step[data-step="${currentStep}"]`);
    const requiredFields = currentForm.querySelectorAll('[required]');
    
    for (const field of requiredFields) {
        if (!field.value.trim()) {
            showMessage('âŒ í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            field.focus();
            return false;
        }
        
        // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
        if (field.type === 'email' && field.value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(field.value)) {
                showMessage('âŒ ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                field.focus();
                return false;
            }
        }
    }
    
    // ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ ê²€ì‚¬
    const checkboxGroups = currentForm.querySelectorAll('.fancy-card input[type="checkbox"]');
    if (currentStep === 2) {
        let checked = false;
        for (const checkbox of checkboxGroups) {
            if (checkbox.checked) {
                checked = true;
                break;
            }
        }
        
        if (!checked) {
            showMessage('âŒ í™ˆí˜ì´ì§€ ìœ í˜•ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return false;
        }
    }
    
    return true;
}

// ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
function updateSummary() {
    const form = document.getElementById('estimateForm');
    const formData = new FormData(form);
    
    const summary = {
        'ì´ë¦„': formData.get('name') || 'ë¯¸ì…ë ¥',
        'ì´ë©”ì¼': formData.get('email') || 'ë¯¸ì…ë ¥',
        'ì „í™”ë²ˆí˜¸': formData.get('phone') || 'ë¯¸ì…ë ¥',
        'íšŒì‚¬/ë¸Œëœë“œ': formData.get('company') || 'ë¯¸ì…ë ¥',
        'ì—…ì¢…': formData.get('industry') || 'ë¯¸ì…ë ¥',
        'í™ˆí˜ì´ì§€ ìœ í˜•': Array.from(formData.getAll('homepageType')).join(', ') || 'ë¯¸ì…ë ¥',
        'í˜ì´ì§€ ê·œëª¨': formData.get('pageScale') || 'ë¯¸ì…ë ¥',
        'ë””ìì¸ ìŠ¤íƒ€ì¼': Array.from(formData.getAll('designStyle')).join(', ') || 'ë¯¸ì…ë ¥',
        'ì°¸ê³  ì‚¬ì´íŠ¸': [
            formData.get('reference1'),
            formData.get('reference2'),
            formData.get('reference3')
        ].filter(Boolean).join(', ') || 'ì—†ìŒ',
        'í•„ìš” ê¸°ëŠ¥': Array.from(formData.getAll('requiredFeatures')).join(', ') || 'ì—†ìŒ',
        'í¬ë§ ì˜¤í”ˆ': formData.get('timeline') || 'ë¯¸ì…ë ¥',
        'ì˜ˆì‚° ë²”ìœ„': formData.get('budget') || 'ë¯¸ì…ë ¥',
        'í”„ë¡œì íŠ¸ ì„¤ëª…': formData.get('projectDescription')?.substring(0, 100) + (formData.get('projectDescription')?.length > 100 ? '...' : '') || 'ë¯¸ì…ë ¥'
    };
    
    let summaryHTML = '';
    for (const [key, value] of Object.entries(summary)) {
        summaryHTML += `
            <div class="summary-item">
                <span class="summary-label">${key}:</span>
                <span class="summary-value">${value}</span>
            </div>
        `;
    }
    
    // ì—¬ê¸°ì— ìš”ì•½ ì •ë³´ë¥¼ í‘œì‹œí•  ìš”ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤
    const summaryElement = document.getElementById('summaryContent');
    if (summaryElement) {
        summaryElement.innerHTML = summaryHTML;
    }
}

// ë©”ì‹œì§€ í‘œì‹œ
function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = text;
    messageDiv.className = `message-fancy ${type}`;
    
    // 5ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

// í¼ ì œì¶œ ì²˜ë¦¬
document.getElementById('estimateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!validateCurrentStep()) {
        return;
    }
    
    // í¼ ë°ì´í„° ìˆ˜ì§‘
    const form = e.target;
    const formData = new FormData(form);
    
    // ê°ì²´ë¡œ ë³€í™˜
    const data = {};
    for (const [key, value] of formData.entries()) {
        if (data[key]) {
            if (Array.isArray(data[key])) {
                data[key].push(value);
            } else {
                data[key] = [data[key], value];
            }
        } else {
            data[key] = value;
        }
    }
    
    // ë°°ì—´ì´ ì•„ë‹Œ ê²ƒì€ ë‹¨ì¼ ê°’ìœ¼ë¡œ ë³€í™˜
    for (const key in data) {
        if (Array.isArray(data[key]) && data[key].length === 1) {
            data[key] = data[key][0];
        }
    }
    
    // ì œì¶œ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
    const submitBtn = form.querySelector('.btn-submit') || form.querySelector('.btn-next-fancy');
    if (submitBtn) {
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì²˜ë¦¬ ì¤‘...';
        submitBtn.disabled = true;
    }
    
    // Google Apps Scriptë¡œ ë°ì´í„° ì „ì†¡
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                showMessage(response.message, 'success');
                form.reset();
                changeStep(1);
                
                // 3ì´ˆ í›„ ì¶•í•˜ ë©”ì‹œì§€
                setTimeout(() => {
                    alert('ğŸ‰ ê²¬ì  ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në¹ ë¥¸ ì‹œì¼ ë‚´ì— ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                }, 2000);
            } else {
                showMessage('âŒ ' + response.message, 'error');
            }
            
            if (submitBtn) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .withFailureHandler(function(error) {
            showMessage('âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            console.error('Submission error:', error);
            
            if (submitBtn) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .submitEstimateRequest(data);
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // URLì—ì„œ step íŒŒë¼ë¯¸í„° í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const stepParam = urlParams.get('step');
    
    if (stepParam && stepParam >= 1 && stepParam <= totalSteps) {
        changeStep(parseInt(stepParam));
    }
    
    // ì—”í„°í‚¤ë¡œ ë‹¤ìŒ ë‹¨ê³„ ì´ë™ ë°©ì§€
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.type !== 'textarea' && e.target.type !== 'submit') {
            e.preventDefault();
        }
    });
    
    // ì¹´ë“œ ì„ íƒ ì• ë‹ˆë©”ì´ì…˜
    const cards = document.querySelectorAll('.fancy-card');
    cards.forEach(card => {
        card.addEventListener('click', function() {
            this.classList.add('clicked');
            setTimeout(() => this.classList.remove('clicked'), 300);
        });
    });
});
</script>
